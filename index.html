<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Machote Urgencias ‚Äî Nota de Evoluci√≥n</title>
  <style>
    :root{
      --bg:#0b1220;
      --muted:#9aa4b2;
      --text:#e7edf6;
      --line:rgba(255,255,255,.08);
      --accent:#77d7ff;
      --accent2:#76f7c6;
      --warn:#ffcf5a;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --pad:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(119,215,255,.18), transparent 60%),
                  radial-gradient(1000px 700px at 90% 10%, rgba(118,247,198,.14), transparent 55%),
                  linear-gradient(180deg, #070b14, #0b1220 35%, #070b14);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:20;
      background:rgba(7,11,20,.8);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px 16px;}
    .topbar{display:flex; gap:14px; align-items:center; justify-content:space-between;}
    .brand{display:flex; flex-direction:column; gap:2px;}
    .brand h1{margin:0; font-size:16px; letter-spacing:.2px;}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;}
    .pill{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .05s ease, border-color .2s ease, background .2s ease;
    }
    .pill:hover{border-color:rgba(127,211,255,.45)}
    .pill:active{transform: translateY(1px)}
    .pill.primary{
      border-color:rgba(118,247,198,.35);
      box-shadow:0 0 0 1px rgba(118,247,198,.08) inset;
    }
    .pill.danger{border-color:rgba(255,207,90,.35);}

    main{max-width:1200px;margin:0 auto;padding:18px 16px 44px;}
    .grid{display:grid; gap:14px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      display:flex; align-items:flex-start; justify-content:space-between;
      padding:16px var(--pad);
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(127,211,255,.08), transparent);
    }
    .titlebox{display:flex;flex-direction:column;gap:4px}
    .titlebox h2{margin:0; font-size:16px;}
    .titlebox .sub{margin:0; font-size:12px; color:var(--muted);}
    .head .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      transition: border-color .2s ease, background .2s ease, transform .05s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{border-color:rgba(127,211,255,.45)}
    .btn:active{transform: translateY(1px)}
    .btn.good{
      border-color:rgba(118,247,198,.35);
      background: rgba(118,247,198,.08);
    }
    .btn.copy{
      border-color:rgba(127,211,255,.40);
      background: rgba(127,211,255,.10);
      color:#eaf7ff;
    }
    .content{
      padding:16px var(--pad);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .content{grid-template-columns: 1fr;} }
    .formgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-content:start;
    }
    @media (max-width: 560px){ .formgrid{grid-template-columns: 1fr;} }
    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin:0 0 6px 2px;
    }
    select, input, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(5,8,15,.55);
      color:var(--text);
      outline:none;
      transition: border-color .2s ease, box-shadow .2s ease;
      font-size:13px;
    }
    textarea{min-height:110px; resize:vertical}
    select:focus, input:focus, textarea:focus{
      border-color:rgba(127,211,255,.5);
      box-shadow: 0 0 0 3px rgba(127,211,255,.12);
    }
    .span2{grid-column: span 2}
    @media (max-width:560px){.span2{grid-column:span 1}}
    .finalbox{
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius2);
      background: rgba(255,255,255,.03);
      padding:14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 260px;
    }
    .finaltop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .finaltop .small{font-size:12px;color:var(--muted);}
    pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12.5px;
      line-height:1.35;
      color:#ecf4ff;
    }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(12,18,34,.92);
      border:1px solid rgba(127,211,255,.25);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .22s ease, transform .22s ease;
      z-index:40;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px);}
    .divider{height:1px;background:var(--line); margin:8px 0 2px;}
    .toggleRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:10px 12px; border:1px solid rgba(255,255,255,.10);
      border-radius:12px; background:rgba(5,8,15,.35)
    }
    .toggleRow label{margin:0; color:var(--text); font-size:13px; display:flex; gap:8px; align-items:center}
    .badge{
      font-size:11px; color:var(--muted);
      border:1px solid rgba(255,255,255,.10);
      padding:2px 8px; border-radius:999px;
      background:rgba(255,255,255,.03);
    }
  
    .muted{color:var(--muted);}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .eduBox{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(255,255,255,.03);
      padding:12px 12px 10px;
    }
    .eduHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .eduBody{display:flex; flex-direction:column; gap:6px;}
    .eduLine{font-size:12.5px; color:var(--text);}

  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Machote de Urgencias ‚Äî Nota de Evoluci√≥n</h1>
        <p>Texto final solo en ‚ÄúNota completa‚Äù.</p>
      </div>
      <div class="actions">
        <button class="pill primary" id="btnAllNormal">‚úÖ Todo normal</button>
        <button class="pill danger" id="btnAllClear">üßπ Limpiar</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- CORE -->
    <section class="card" id="cardCore">
      <div class="head">
        <div class="titlebox">
          <h2>Core</h2>
          <p class="sub">Fecha auto (editable), SV, narrativa, solicitud y comunicaci√≥n.</p>
        </div>
        <div class="right">
          <button class="btn good" id="coreNormal">Normal</button>
          <button class="btn" id="coreClear">Limpiar</button>
        </div>
      </div>

      <div class="content">
        <div class="formgrid span2">
          <div>
            <label>Fecha</label>
            <input id="n_date" placeholder="Ej. 04.01.26" />
          </div>
          <div>
            <label>Servicio que valora</label>
            <input id="n_service" placeholder="Ej. Urgencias / MI / Pediatr√≠a..." />
          </div>

          <div>
            <label>Sexo</label>
            <select id="n_sex">
              <option value="m">Hombre</option>
              <option value="f">Mujer</option>
            </select>
          </div>
          <div>
            <label> </label>
            <div class="toggleRow">
              <label><input type="checkbox" id="opt_ef" checked> Anamnesis + EF</label>
              <label><input type="checkbox" id="opt_iv" checked> Canalizaci√≥n</label>
              <label><input type="checkbox" id="opt_med" checked> Medicaci√≥n</label>
            </div>
          </div>

          <div class="span2">
            <label>Signos vitales</label>
            <div class="formgrid">
              <div><label>TA (mmHg)</label><input id="sv_ta" placeholder="120/80" /></div>
              <div><label>FC (lpm)</label><input id="sv_fc" placeholder="80" /></div>
              <div><label>FR (rpm)</label><input id="sv_fr" placeholder="18" /></div>
              <div><label>Temperatura (¬∞C)</label><input id="sv_temp" placeholder="36.7" /></div>
              <div class="span2"><label>SpO‚ÇÇ (%)</label><input id="sv_spo2" placeholder="96" /></div>
            </div>
          </div>

          <div class="span2">
            <label>Canalizaci√≥n (si aplica)</label>
            <div class="formgrid">
              <div><label>Soluci√≥n</label><input id="iv_sol" placeholder="+" /></div>
              <div><label>Velocidad (cc/h)</label><input id="iv_rate" placeholder="+" /></div>
            </div>
          </div>

          <div class="span2">
            <label>Medicaci√≥n (si aplica)</label>
            <div class="formgrid">
              <div><label>F√°rmaco</label><input id="med_name" placeholder="+" /></div>
              <div><label>Para manejo de</label><input id="med_for" placeholder="+" /></div>
            </div>
          </div>

          <div class="span2">
            <label>Solicitud de estudios (separados)</label>
            <div class="toggleRow">
              <label><input type="checkbox" id="opt_labs" checked> Laboratorio</label>
              <label><input type="checkbox" id="opt_imgreq" checked> Gabinete</label>
            </div>
            <div class="formgrid" style="margin-top:10px">
              <div><label>Laboratorio</label><input id="req_labs" placeholder="Ej. BH, QS, EGO" /></div>
              <div><label>Gabinete</label><input id="req_img" placeholder="Ej. Radiograf√≠a de t√≥rax" /></div>
            </div>
          </div>

          <div class="span2">
            <label>Comunicaci√≥n</label>
            <div class="toggleRow">
              <label><input type="checkbox" id="opt_comm" checked> Incluir ‚ÄúNos comunicamos‚Ä¶‚Äù</label>
            </div>
            <div class="formgrid" style="margin-top:10px">
              <div><label>Nombre</label><input id="doc_name" placeholder="Dr. ****" /></div>
              <div><label>Rol / servicio</label><input id="doc_role" placeholder="(M√©dico ***)" /></div>
              <div class="span2"><label>Decide / indicaciones</label><input id="doc_decision" placeholder="+" /></div>
            </div>
          </div>

          <div class="span2">
            <label>Seguimiento ambulatorio (opcional)</label>
            <div class="toggleRow">
              <label><input type="checkbox" id="opt_follow"> Incluir p√°rrafo de seguimiento + contacto</label>
            </div>
            <div class="formgrid" style="margin-top:10px">
              <div><label>Contacto (Dr./Dra.)</label><input id="follow_doc" placeholder="Dr. ___" /></div>
            </div>
          </div>

          <div class="span2">
            <label>Egreso / Disposici√≥n</label>
            <select id="dispo">
              <option value="egreso">Egresa del servicio de urgencias estable, sin eventualidades.</option>
              <option value="ingreso">Se decide ingreso a hospitalizaci√≥n.</option>
              <option value="obs">Se decide estancia en observaci√≥n.</option>
              <option value="ref">Se decide referencia/traslado a otra unidad.</option>
              <option value="custom">Personalizar (escribir abajo)</option>
            </select>
          </div>
          <div class="span2">
            <label>Texto de disposici√≥n (si personalizar)</label>
            <input id="dispo_custom" placeholder="Ej. Ingreso a piso, traslado, etc." />
          </div>

          <div class="span2">
            <label>Notas adicionales (opcional)</label>
            <textarea id="n_extra" placeholder="(opcional)"></textarea>
          </div>
        </div>
      </div>
    </section>

    <!-- GAS -->
    <section class="card" id="cardGas">
      <div class="head">
        <div class="titlebox">
          <h2>Gasometr√≠a</h2>
          <p class="sub">Dudas: https://drive.google.com/file/d/14MJpVImV_TBvUMpRTrCi2oIO6NAXVfdd/view?usp=sharing</p>
        </div>
        <div class="right">
          <span class="badge">Opcional</span>
          <button class="btn good" id="gasNormal">Normal</button>
          <button class="btn" id="gasClear">Limpiar</button>
        </div>
      </div>
      <div class="content">
        <div class="formgrid span2">
          <div><label>pH</label><input id="g_ph" /></div>
          <div><label>PCO‚ÇÇ</label><input id="g_pco2" /></div>
          <div><label>PO‚ÇÇ</label><input id="g_po2" /></div>
          <div><label>Hb</label><input id="g_hb" /></div>
          <div><label>sO‚ÇÇ</label><input id="g_so2" /></div>
          <div><label>AG</label><input id="g_ag" /></div>
          <div><label>EB</label><input id="g_eb" /></div>
          <div><label>HCO‚ÇÉ</label><input id="g_hco3" /></div>
          <div><label>K</label><input id="g_k" /></div>
          <div><label>Na</label><input id="g_na" /></div>
          <div><label>Ca</label><input id="g_ca" /></div>
          <div><label>Cl</label><input id="g_cl" /></div>
          <div><label>Alb√∫mina (g/dL) <span class="muted">(opcional)</span></label><input id="g_alb" placeholder="4.0" /></div>
          <div><label>Glu</label><input id="g_glu" /></div>
          <div><label>Lac</label><input id="g_lac" /></div>
          <div><label>p50</label><input id="g_p50" /></div>
          <div class="span2"><label>Hallazgos</label><input id="g_find" /></div>
          <div class="span2">
            <label>Si PaCO‚ÇÇ fuera de 35‚Äì45, ¬øagudo o cr√≥nico? <span class="muted">(educativo)</span></label>
            <div class="toggleRow">
              <label><input type="radio" name="g_chronicity" value="agudo" checked> Agudo</label>
              <label><input type="radio" name="g_chronicity" value="cronico"> Cr√≥nico</label>
            </div>
          </div>

          <div class="span2">
            <div class="eduBox">
              <div class="eduHead">
                <strong>Interpretaci√≥n r√°pida (no se pega en la nota)</strong>
                <span class="badge mono" id="g_status">‚Äî</span>
              </div>
              <div class="eduBody">
                <div class="eduLine"><strong>Resumen:</strong> <span id="g_summary">Ingresa pH, PaCO‚ÇÇ y HCO‚ÇÉ‚Åª.</span></div>
                <div class="eduLine"><strong>pH:</strong> <span id="g_phExplain">‚Äî</span></div>
                <div class="eduLine"><strong>Primario(s):</strong> <span id="g_primaryExplain">‚Äî</span></div>
                <div class="eduLine"><strong>Compensaci√≥n:</strong> <span id="g_compExplain">‚Äî</span></div>
                <div class="eduLine"><strong>Anion gap:</strong> <span id="g_agExplain">‚Äî</span></div>
                <div class="hint" style="margin-top:8px;">
                  F√≥rmulas: AG = Na ‚àí (Cl + HCO‚ÇÉ). Si alb√∫mina: AGcorr = AG + 2.5 √ó (4 ‚àí Alb).
                </div>
              </div>
            </div>
          </div>
          <div class="span2"><div class="toggleRow"><label><input type="checkbox" id="incl_gas"> Incluir en nota</label></div></div>
        </div>
      </div>
    </section>

    <!-- ECG -->
    <section class="card" id="cardECG">
      <div class="head">
        <div class="titlebox">
          <h2>ECG 12 derivaciones</h2>
          <p class="sub">Opcional (sin ‚Äúposici√≥n‚Äù).</p>
        </div>
        <div class="right">
          <span class="badge">Opcional</span>
          <button class="btn good" id="ecgNormal">Normal</button>
          <button class="btn" id="ecgClear">Limpiar</button>
        </div>
      </div>
      <div class="content">
        <div class="formgrid span2">
          <div><label>Ritmo</label><input id="e_ritmo" placeholder="sinusal" /></div>
          <div><label>FC (lpm)</label><input id="e_fc" placeholder="80" /></div>
          <div><label>P (ms)</label><input id="e_p" /></div>
          <div><label>PR (ms)</label><input id="e_pr" /></div>
          <div><label>QRS (ms)</label><input id="e_qrs" /></div>
          <div><label>QTm (ms)</label><input id="e_qtm" /></div>
          <div><label>QTc (ms) <span class="muted">(auto)</span> <span class="badge" id="e_qtc_method">‚Äî</span></label><input id="e_qtc" readonly /></div>
          <div><label>Eje. Consultar: https://memodiapp.com/App/Calculus/ECG-eje.html </label><input id="e_eje" placeholder="normal" /></div>
          <div><label>Transici√≥n</label><input id="e_trans" /></div>
          <div class="span2"><label>Hallazgos</label><input id="e_find" placeholder="sin alteraciones agudas" /></div>
          <div class="span2"><div class="toggleRow"><label><input type="checkbox" id="incl_ecg"> Incluir en nota</label></div></div>
        </div>
      </div>
    </section>

    <!-- GABINETE -->
    <section class="card" id="cardIMG">
      <div class="head">
        <div class="titlebox">
          <h2>Estudios de gabinete</h2>
          <p class="sub">Agrega solo los realizados. Plantillas listas (CT/Rx/TAC/Angio/Perfu). Texto final se pega en ‚ÄúNota completa‚Äù.</p>
        </div>
        <div class="right">
          <span class="badge">Opcional</span>
          <button class="btn good" id="imgAdd">+ Agregar estudio</button>
          <button class="btn" id="imgClear">Limpiar</button>
        </div>
      </div>
      <div class="content">
        <div class="formgrid span2">
          <div class="span2"><div class="toggleRow"><label><input type="checkbox" id="incl_img"> Incluir en nota</label><span class="badge">Si no marcas, no se imprime</span></div></div>
          <div class="span2" id="imgList"></div>
        </div>
      </div>
    </section>

    <!-- M√âDICOS -->
    <section class="card" id="cardStaff">
      <div class="head">
        <div class="titlebox">
          <h2>M√©dicos</h2>
          <p class="sub">Salida final con ‚Äú // ‚Äù.</p>
        </div>
        <div class="right">
          <button class="btn good" id="staffNormal">Normal</button>
          <button class="btn" id="staffClear">Limpiar</button>
        </div>
      </div>
      <div class="content">
        <div class="formgrid span2">
          <div class="span2">
            <label>M√©dicos adscritos (hasta 2)</label>
            <div class="formgrid">
              <div>
                <label>Adscrit@ 1</label>
                <div class="formgrid">
                  <div><label>Prefijo</label><select id="ads1_pref"><option value="Dr.">Dr.</option><option value="Dra.">Dra.</option></select></div>
                  <div><label>Nombre</label><input id="ads1_name" /></div>
                </div>
              </div>
              <div>
                <label>Adscrit@ 2</label>
                <div class="formgrid">
                  <div><label>Prefijo</label><select id="ads2_pref"><option value="Dr.">Dr.</option><option value="Dra.">Dra.</option></select></div>
                  <div><label>Nombre</label><input id="ads2_name" /></div>
                </div>
              </div>
            </div>
          </div>

          <div class="span2">
            <label>M√©dicos residentes (hasta 4)</label>
            <div class="formgrid">
              
              <div class="span2">
                <label>Residente 1</label>
                <div class="formgrid">
                  <div><label>Prefijo</label><select id="res1_pref"><option value="Dr.">Dr.</option><option value="Dra.">Dra.</option></select></div>
                  <div><label>Nombre</label><input id="res1_name" placeholder="Nombre Apellido" /></div>
                  <div><label>R</label><select id="res1_r"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                  <div><label>Especialidad</label><select id="res1_spec"><option value="MI">MI</option><option value="CG">CG</option><option value="other">Otro</option></select></div>
                  <div class="span2"><label>Otro servicio (si aplica)</label><input id="res1_other" placeholder="Ej. Pediatr√≠a" /></div>
                </div>
              </div>
    

              <div class="span2">
                <label>Residente 2</label>
                <div class="formgrid">
                  <div><label>Prefijo</label><select id="res2_pref"><option value="Dr.">Dr.</option><option value="Dra.">Dra.</option></select></div>
                  <div><label>Nombre</label><input id="res2_name" placeholder="Nombre Apellido" /></div>
                  <div><label>R</label><select id="res2_r"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                  <div><label>Especialidad</label><select id="res2_spec"><option value="MI">MI</option><option value="CG">CG</option><option value="other">Otro</option></select></div>
                  <div class="span2"><label>Otro servicio (si aplica)</label><input id="res2_other" placeholder="Ej. Pediatr√≠a" /></div>
                </div>
              </div>
    

              <div class="span2">
                <label>Residente 3</label>
                <div class="formgrid">
                  <div><label>Prefijo</label><select id="res3_pref"><option value="Dr.">Dr.</option><option value="Dra.">Dra.</option></select></div>
                  <div><label>Nombre</label><input id="res3_name" placeholder="Nombre Apellido" /></div>
                  <div><label>R</label><select id="res3_r"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                  <div><label>Especialidad</label><select id="res3_spec"><option value="MI">MI</option><option value="CG">CG</option><option value="other">Otro</option></select></div>
                  <div class="span2"><label>Otro servicio (si aplica)</label><input id="res3_other" placeholder="Ej. Pediatr√≠a" /></div>
                </div>
              </div>
    

              <div class="span2">
                <label>Residente 4</label>
                <div class="formgrid">
                  <div><label>Prefijo</label><select id="res4_pref"><option value="Dr.">Dr.</option><option value="Dra.">Dra.</option></select></div>
                  <div><label>Nombre</label><input id="res4_name" placeholder="Nombre Apellido" /></div>
                  <div><label>R</label><select id="res4_r"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                  <div><label>Especialidad</label><select id="res4_spec"><option value="MI">MI</option><option value="CG">CG</option><option value="other">Otro</option></select></div>
                  <div class="span2"><label>Otro servicio (si aplica)</label><input id="res4_other" placeholder="Ej. Pediatr√≠a" /></div>
                </div>
              </div>
    
            </div>
          </div>

          <div class="span2">
            <label>MIP (solo 1)</label>
            <input id="mip_name" />
          </div>
        </div>
      </div>
    </section>

    <!-- NOTA COMPLETA -->
    <section class="card" id="cardAll">
      <div class="head">
        <div class="titlebox">
          <h2>Nota completa</h2>
          <p class="sub">√önica caja de texto. Se actualiza en tiempo real.</p>
        </div>
        <div class="right">
          <button class="btn copy" data-copy="allText">Copiar</button>
        </div>
      </div>
      <div class="content">
        <div class="finalbox" style="grid-column:1/-1;">
          <div class="finaltop">
            <div class="small">Texto final ‚Äî Nota completa</div>
            <button class="btn copy" data-copy="allText">Copiar</button>
          </div>
          <div class="divider"></div>
          <pre id="allText"></pre>
        </div>
      </div>
    </section>
  </div>
</main>

<div class="toast" id="toast">Copiado ‚úÖ</div>

<script>
  const $ = (id)=>document.getElementById(id);

  const toast = (msg="Copiado ‚úÖ")=>{
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 900);
  };

  const copyText = async (text)=>{
    try{
      await navigator.clipboard.writeText(text);
      toast();
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("Copiado (fallback) ‚úÖ");
    }
  };

  const joinClean = (parts, sep=" ")=>{
    return parts.map(x=>String(x||"").trim()).filter(Boolean).join(sep);
  };

  // ===== Plantillas de gabinete =====
  const IMG_TEMPLATES = {
    "TAC simple de t√≥rax": "TAC simple de t√≥rax: Se observan arcos costales sin soluci√≥n de continuidad, sin datos de contusi√≥n pulmonar, neumot√≥rax o hemot√≥rax. Resto sin alteraciones (reporte verbal).",
    "TAC simple de abdomen": "TAC simple de abdomen: Se observa cavidad abdominal con presencia de coprostasis en colon ascendente, descendente y ampolla rectal, sin presencia de l√≠quido o aire libre, sin da√±o a v√≠scera hueca. Resto sin alteraciones (reporte verbal).",
    "TAC macizo facial sin contraste (detallada)": "TAC macizo facial sin contraste: Adecuado desarrollo y neumatizaci√≥n de senos paranasales. Desviaci√≥n septal a la de Cottle. Cornetes normotr√≥ficos. Densidad similar a aire. Hueso frontal (tablas interna y externa), rebordes supra e infraorbitarios, cigom√°ticos, nasales, maxilares y mand√≠bulas (c√≥ndilos, ramas, √°ngulos, cuerpos, s√≠nfisis y paras√≠nfisis) sin trazo de fractura aparente. Resto de estudio de imagen sin alteraciones otorrinolaringol√≥gicas aparentes.",
    "TAC de cr√°neo simple": "TAC de cr√°neo simple: Se realizan cortes de la base a la convexidad, tejidos blandos sin alteraciones, tejidos √≥seos sin soluci√≥n de continuidad, par√©nquima encef√°lico sin datos de hemorragia, isquemia o edema. L√≠nea media central, ventr√≠culos sin dilataciones ni lesiones ocupativas. Reporte verbal.",
    "Tomograf√≠a de macizo facial (breve)": "Tomograf√≠a de macizo facial: Adecuado desarrollo y neumatizaci√≥n de senos paranasales, huesos nasales, hueso frontal, reborde supra e infraorbitario, maxilares, cigom√°ticos, mand√≠bula (s√≠nfisis, paras√≠nfisis, cuerpo, √°ngulo, ramas, c√≥ndilos) sin trazos de fractura.",
    "AngioTAC": "AngioTAC: Visualizaci√≥n de las estructuras vasculares intracraneales sin evidencia de estenosis, aneurismas, malformaciones arteriovenosas, ni oclusiones significativas. Vasculatura sim√©trica y sin irregularidades aparentes.",
    "PerfuTAC": "PerfuTAC: Se observa adecuada perfusi√≥n cerebral sin evidencia de √°reas de hipoperfusi√≥n, isquemia o infarto cerebral. No se identifican alteraciones en los par√°metros hemodin√°micos cerebrales.",
    "Radiograf√≠a de t√≥rax PA y lateral": "Radiograf√≠a de t√≥rax PA y lateral: Columna de aire central de apariencia permeable, recesos cardiofr√©nicos y costodiafragm√°ticos libres. Par√©nquima pulmonar sin alteraciones. Tejidos blandos y √≥seos sin alteraciones aparentes.",
    "Radiograf√≠a de abdomen": "Radiograf√≠a de abdomen: Tejidos blandos y √≥seos de caracter√≠sticas normales. Visualizaci√≥n adecuada de l√≠neas preperitoneales, visibles en todo su trayecto, sin presencia de aire libre en cavidad abdominal. Aire presente en √°mpula rectal. Coprostasis en silueta col√≥nica.",
    "Radiograf√≠a AP y lateral de cervicales": "Radiograf√≠a AP y lateral de cervicales: Adecuada congruencia articular, sin datos de soluci√≥n √≥sea, listesis o lisis.",
    "Radiograf√≠as AP y lateral de columna dorsal": "Radiograf√≠as AP y lateral de columna dorsal: Sin p√©rdida de continuidad √≥sea, congruencia articular conservada, sin lisis ni listesis.",
    "Radiograf√≠as AP y lateral de columna lumbosacra": "Radiograf√≠as AP y lateral de columna lumbosacra: Sin lisis ni listesis. Sin soluci√≥n de continuidad √≥sea aparente. Congruencia articular conservada.",
    "Radiograf√≠as AP de pelvis": "Radiograf√≠as AP de pelvis: Sin soluci√≥n de continuidad √≥sea aparente. Congruencia articular conservada.",
    "Radiograf√≠as AP y lateral de mu√±eca derecha": "Radiograf√≠as AP y lateral de mu√±eca derecha: Sin soluci√≥n de continuidad √≥sea aparente. Congruencia articular conservada.",
    "Radiograf√≠as AP, lateral y de mortaja del tobillo": "Radiograf√≠as AP, lateral y de mortaja del tobillo: Sin soluci√≥n de continuidad √≥sea aparente. Congruencia articular conservada.",
    "Radiograf√≠a AP y lateral de columna cervical (rectificaci√≥n)": "Radiograf√≠a AP y lateral de columna cervical: Se observa rectificaci√≥n de la lordosis cervical. No se observan soluciones de continuidad √≥seas. Congruencia articular conservada."
  };

  let imgItems = []; // {id, studyKey, mode, name, findings}
  const uid = ()=> Math.random().toString(36).slice(2,10);

  function addImgItem(studyKey="Radiograf√≠a de t√≥rax PA y lateral"){
    const id = uid();
    const mode = (studyKey==="manual") ? "Manual" : "Plantilla";
    const name = (studyKey==="manual") ? "" : studyKey;
    const findings = IMG_TEMPLATES[studyKey] || "";
    imgItems.push({id, studyKey, mode, name, findings});
    renderImgList();
  }

  function clearImgItems(){
    imgItems = [];
    renderImgList();
  }

  function renderImgList(){
    const box = $("imgList");
    if(!box) return;
    if(imgItems.length===0){
      box.innerHTML = '<div class="muted" style="padding:6px 2px">Sin estudios agregados. Usa ‚Äú+ Agregar estudio‚Äù.</div>';
      return;
    }

    const studyOpts = Object.keys(IMG_TEMPLATES)
      .map(k=>`<option value="${k.replace(/"/g,'&quot;')}">${k}</option>`)
      .join('');

    box.innerHTML = imgItems.map((it, idx)=>{
      const safeId = it.id;
      const isManualStudy = (it.studyKey==="manual");
      return `
        <div class="finalbox" style="min-height:unset">
          <div class="finaltop">
            <div class="small">Estudio ${idx+1}</div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn" type="button" data-img-del="${safeId}">Quitar</button>
            </div>
          </div>
          <div class="formgrid">
            <div>
              <label>Estudio</label>
              <select data-img-study="${safeId}">
                <option value="manual">(manual / otro)</option>
                ${studyOpts}
              </select>
            </div>
            <div>
              <label>Modo</label>
              <select data-img-mode="${safeId}">
                <option value="Plantilla">Plantilla</option>
                <option value="Manual">Manual</option>
              </select>
            </div>
            <div class="span2" style="${isManualStudy?'':'display:none'}">
              <label>Nombre (solo si manual)</label>
              <input data-img-name="${safeId}" value="${(it.name||'').replace(/"/g,'&quot;')}" placeholder="Ej. TAC simple de cr√°neo" />
            </div>
            <div class="span2">
              <label>Hallazgos</label>
              <textarea data-img-find="${safeId}" placeholder="Escribe o usa plantilla‚Ä¶">${it.findings||''}</textarea>
            </div>
          </div>
        </div>`;
    }).join('');

    // set selects and readonly/visibility
    imgItems.forEach(it=>{
      const selStudy = box.querySelector(`[data-img-study="${it.id}"]`);
      const selMode  = box.querySelector(`[data-img-mode="${it.id}"]`);
      const ta       = box.querySelector(`[data-img-find="${it.id}"]`);
      const nameIn   = box.querySelector(`[data-img-name="${it.id}"]`);
      if(selStudy) selStudy.value = (it.studyKey && IMG_TEMPLATES[it.studyKey]) ? it.studyKey : 'manual';
      if(selMode)  selMode.value  = it.mode || ((selStudy && selStudy.value==='manual') ? 'Manual':'Plantilla');
      if(ta){
        const manual = (selStudy && selStudy.value==='manual') || (selMode && selMode.value==='Manual');
        ta.readOnly = !manual;
      }
      if(nameIn){
        const isManual = (selStudy && selStudy.value==='manual');
        const wrap = nameIn.closest('.span2');
        if(wrap) wrap.style.display = isManual ? '' : 'none';
      }
    });
  }



  // ===== C√°lculos autom√°ticos =====
  const parseNum = (v)=>{
    const s = String(v||"").trim().replace(/,/g,'.');
    const x = parseFloat(s);
    return Number.isFinite(x) ? x : NaN;
  };

  // QTc auto:
  // - Bazett si FC 60‚Äì100
  // - Fridericia si FC <60 o >100
  function updateQTcAuto(){
    const qt = parseNum($("e_qtm")?.value); // ms
    const hr = parseNum($("e_fc")?.value);  // lpm
    const out = $("e_qtc");
    const badge = $("e_qtc_method");

    if(!Number.isFinite(qt) || !Number.isFinite(hr) || hr<=0){
      if(out) out.value = "";
      if(badge) badge.textContent = "‚Äî";
      return;
    }

    const rr = 60 / hr;          // s
    const qtSec = qt / 1000;     // s

    let qtcSec, method;
    if(hr < 60 || hr > 100){
      qtcSec = qtSec / Math.cbrt(rr);
      method = "Fridericia";
    }else{
      qtcSec = qtSec / Math.sqrt(rr);
      method = "Bazett";
    }

    const qtcMs = qtcSec * 1000;
    if(out) out.value = (Math.round(qtcMs*100)/100).toFixed(2);
    if(badge) badge.textContent = method;
  }

  // Anion gap: AG = Na ‚àí (Cl + HCO3). Si alb√∫mina: AGcorr = AG + 2.5*(4 ‚àí Alb)
  // Nota: el valor se coloca en el campo "AG" (g_ag). No se a√±ade texto extra al reporte.
  function updateAnionGap(){
    const na = parseFloat($("g_na")?.value);
    const cl = parseFloat($("g_cl")?.value);
    const hco3 = parseFloat($("g_hco3")?.value);
    if(!Number.isFinite(na) || !Number.isFinite(cl) || !Number.isFinite(hco3)) return;

    const ag = na - (cl + hco3);
    const alb = parseFloat($("g_alb")?.value);
    let val = ag;
    if(Number.isFinite(alb)){
      val = ag + 2.5 * (4 - alb);
    }
    if($("g_ag")) $("g_ag").value = (Math.round(val * 10) / 10).toFixed(1);
  }

  function gasChronicity(){
    const v = document.querySelector('input[name="g_chronicity"]:checked')?.value;
    return v || "agudo";
  }

  // Interpretaci√≥n educativa de gasometr√≠a (no se pega en la nota)
  function renderGasEducation(){
    const ph = parseFloat($("g_ph")?.value);
    const paco2 = parseFloat($("g_pco2")?.value);
    const hco3 = parseFloat($("g_hco3")?.value);

    const status = $("g_status"), sum = $("g_summary"),
          phEx = $("g_phExplain"), primEx = $("g_primaryExplain"),
          compEx = $("g_compExplain"), agEx = $("g_agExplain");

    if(!status || !sum || !phEx || !primEx || !compEx || !agEx) return;

    if(!Number.isFinite(ph) || !Number.isFinite(paco2) || !Number.isFinite(hco3)){
      status.textContent = "‚Äî";
      sum.textContent = "Ingresa pH, PaCO‚ÇÇ y HCO‚ÇÉ‚Åª.";
      phEx.textContent = "‚Äî";
      primEx.textContent = "‚Äî";
      compEx.textContent = "‚Äî";
      agEx.textContent = "‚Äî";
      return;
    }

    status.textContent = "OK";

    // pH state
    let phState = "pH normal";
    if(ph < 7.35) phState = "Acidemia";
    else if(ph > 7.45) phState = "Alcalemia";
    phEx.textContent = `${ph.toFixed(2)} ‚Üí ${phState}`;

    // Primary disorders (simple thresholds)
    const hasMetAc  = (hco3 < 22);
    const hasMetAl  = (hco3 > 26);
    const hasRespAc = (paco2 > 45);
    const hasRespAl = (paco2 < 35);

    const primary = [];
    if(hasMetAc) primary.push("Acidosis metab√≥lica");
    if(hasMetAl) primary.push("Alcalosis metab√≥lica");
    if(hasRespAc) primary.push("Acidosis respiratoria");
    if(hasRespAl) primary.push("Alcalosis respiratoria");
    primEx.textContent = primary.length ? primary.join(" + ") : "Sin trastorno claro por umbrales simples";

    // Compensation (basic)
    let compTxt = "‚Äî";
    if(hasMetAc){
      const expected = 1.5*hco3 + 8;
      const low = expected - 2, high = expected + 2;
      compTxt = `Winter: PaCO‚ÇÇ esperada ${expected.toFixed(1)} (rango ${low.toFixed(1)}‚Äì${high.toFixed(1)}). `;
      compTxt += (paco2 < low) ? "PaCO‚ÇÇ menor ‚Üí alcalosis resp agregada" :
                 (paco2 > high) ? "PaCO‚ÇÇ mayor ‚Üí acidosis resp agregada" :
                 "Compensaci√≥n apropiada";
    } else if(hasMetAl){
      const expected = 40 + 0.7*(hco3 - 24);
      const low = expected - 2, high = expected + 2;
      compTxt = `Met alcalosis: PaCO‚ÇÇ esperada ${expected.toFixed(1)} (rango ${low.toFixed(1)}‚Äì${high.toFixed(1)}). `;
      compTxt += (paco2 < low) ? "PaCO‚ÇÇ menor ‚Üí alcalosis resp agregada" :
                 (paco2 > high) ? "PaCO‚ÇÇ mayor ‚Üí acidosis resp agregada" :
                 "Compensaci√≥n apropiada";
    } else if(hasRespAc){
      const delta = paco2 - 40;
      const chr = gasChronicity();
      const expected = (chr==="agudo") ? (24 + 0.1*delta) : (24 + 0.5*delta);
      const low = expected - 2, high = expected + 2;
      compTxt = `Resp ac (${chr}): HCO‚ÇÉ esperado ${expected.toFixed(1)} (rango ${low.toFixed(1)}‚Äì${high.toFixed(1)}). `;
      compTxt += (hco3 < low) ? "HCO‚ÇÉ menor ‚Üí acidosis metab agregada" :
                 (hco3 > high) ? "HCO‚ÇÉ mayor ‚Üí alcalosis metab agregada" :
                 "Compensaci√≥n apropiada";
    } else if(hasRespAl){
      const delta = 40 - paco2;
      const chr = gasChronicity();
      const expected = (chr==="agudo") ? (24 - 0.2*delta) : (24 - 0.5*delta);
      const low = expected - 2, high = expected + 2;
      compTxt = `Resp al (${chr}): HCO‚ÇÉ esperado ${expected.toFixed(1)} (rango ${low.toFixed(1)}‚Äì${high.toFixed(1)}). `;
      compTxt += (hco3 < low) ? "HCO‚ÇÉ menor ‚Üí acidosis metab agregada" :
                 (hco3 > high) ? "HCO‚ÇÉ mayor ‚Üí alcalosis metab agregada" :
                 "Compensaci√≥n apropiada";
    }
    compEx.textContent = compTxt;

    // AG (use already-updated field if available)
    const na = parseFloat($("g_na")?.value);
    const cl = parseFloat($("g_cl")?.value);
    const alb = parseFloat($("g_alb")?.value);
    if(Number.isFinite(na) && Number.isFinite(cl)){
      const ag = na - (cl + hco3);
      if(Number.isFinite(alb)){
        const agc = ag + 2.5*(4 - alb);
        agEx.textContent = `AG ${ag.toFixed(1)}; AG corregido ${agc.toFixed(1)} (Alb ${alb.toFixed(1)})`;
      } else {
        agEx.textContent = `AG ${ag.toFixed(1)} (sin correcci√≥n por alb√∫mina)`;
      }
    } else {
      agEx.textContent = "Faltan Na/Cl para calcular AG";
    }

    const summaryBits = [phState];
    if(primary.length) summaryBits.push(primary.join(" + "));
    if(Number.isFinite(na) && Number.isFinite(cl)){
      const agNow = na - (cl + hco3);
      summaryBits.push((agNow>12) ? "AG alto" : "AG no alto");
    }
    sum.textContent = summaryBits.join(" ¬∑ ");
  }


  const fmtSV = ()=>{
    const ta = $("sv_ta").value.trim();
    const fc = $("sv_fc").value.trim();
    const fr = $("sv_fr").value.trim();
    const te = $("sv_temp").value.trim();
    const sp = $("sv_spo2").value.trim();
    return `Signos Vitales: TA ${ta} mmHg  |  FC ${fc} lpm |  FR ${fr} rpm  |  Temperatura ${te} ¬∞C  |  SpO2 ${sp} %`;
  };

  function dispoText(){
    const v = $("dispo").value;
    if(v==="egreso") return "Egresa del servicio de urgencias estable, sin eventualidades.";
    if(v==="ingreso") return "Se decide ingreso a hospitalizaci√≥n.";
    if(v==="obs") return "Se decide estancia en observaci√≥n.";
    if(v==="ref") return "Se decide referencia/traslado a otra unidad.";
    return $("dispo_custom").value.trim() || "Se decide conducta a determinar.";
  }

  function pacienteSegunSexo(){
    const isM = $("n_sex").value === "m";
    const sx = isM ? "masculino" : "femenino";
    const val = isM ? "valorado" : "valorada";
    return `Paciente ${sx} ${val}`;
  }

  

  function buildReqText(){
    const wantLabs = $("opt_labs").checked;
    const wantImg  = $("opt_imgreq").checked;

    const labs = $("req_labs").value.trim();
    const img  = $("req_img").value.trim();

    if(!wantLabs && !wantImg) return "";

    const a = wantLabs ? (labs || "*") : "";
    const b = wantImg ? (img || "*") : "";

    if(wantLabs && wantImg){
      return `Se solicita ${a} como estudio(s) de laboratorio as√≠ como ${b} como estudio(s) de gabinete.`;
    }
    if(wantLabs){
      return `Se solicita ${a} como estudio(s) de laboratorio.`;
    }
    return `Se solicita ${b} como estudio(s) de gabinete.`;
  }

  function buildComm(){
    if(!$("opt_comm").checked) return "";
    const name = $("doc_name").value.trim() || "Dr. ****";
    const role = $("doc_role").value.trim() || "(M√©dico ***)";
    const dec  = $("doc_decision").value.trim() || "+";
    return `Nos comunicamos con el ${name}, ${role}, quien enterado del caso dicta indicaciones y decide ${dec}.`;
  }

  
  function buildCoreNarrative(){
    const service = $("n_service").value.trim() || "*";

    const efText = $("opt_ef").checked ? "Se realiza exploraci√≥n f√≠sica completa e interrogatorio dirigido." : "";

    const ivSol = $("iv_sol").value.trim();
    const ivRate = $("iv_rate").value.trim();
    const ivText = $("opt_iv").checked ? `Como parte del abordaje inicial, se canaliza con soluci√≥n ${ivSol || "+"} a una velocidad de infusi√≥n de ${ivRate || "+"} cc/h.` : "";

    const medName = $("med_name").value.trim();
    const medFor  = $("med_for").value.trim();
    const medText = $("opt_med").checked ? `Se decide administrar ${medName || "+"} para manejo de ${medFor || "+"}.` : "";

    return `${pacienteSegunSexo()} por el servicio de ${service}. ${[efText, ivText, medText].map(s=>String(s||"").trim()).filter(Boolean).join(" ")}`.replace(/\s+/g," ").trim();
  }

  function buildGas(){
    const hall = $("g_find").value.trim();
    const any = ["g_ph","g_pco2","g_po2","g_hb","g_so2","g_ag","g_eb","g_hco3","g_k","g_na","g_ca","g_cl","g_glu","g_lac","g_p50"]
      .some(id=>$(id).value.trim()) || hall;
    if(!any) return "ESTUDIOS PARACL√çNICOS: ‚Äî";

    return `ESTUDIOS PARACL√çNICOS:
pH: ${$("g_ph").value.trim() || ""}  PCO2: ${$("g_pco2").value.trim() || ""}  PO2: ${$("g_po2").value.trim() || ""}  Hb: ${$("g_hb").value.trim() || ""}  sO: ${$("g_so2").value.trim() || ""}  AG: ${$("g_ag").value.trim() || ""}  EB: ${$("g_eb").value.trim() || ""}  HCO3: ${$("g_hco3").value.trim() || ""}  K: ${$("g_k").value.trim() || ""}  Na: ${$("g_na").value.trim() || ""}  Ca: ${$("g_ca").value.trim() || ""}  Cl: ${$("g_cl").value.trim() || ""}  Glu: ${$("g_glu").value.trim() || ""}  Lac: ${$("g_lac").value.trim() || ""}
p50: ${$("g_p50").value.trim() || ""}  Hallazgos: ${hall || ""}`.trim();
  }

  function buildECG(){
    const any = ["e_ritmo","e_fc","e_p","e_pr","e_qrs","e_qtm","e_qtc","e_eje","e_trans","e_find"].some(id=>$(id).value.trim());
    if(!any) return "Electrocardiograma 12 derivaciones: ‚Äî";
    return `Electrocardiograma 12 derivaciones: Ritmo: ${$("e_ritmo").value.trim()}  FC: ${$("e_fc").value.trim()} lpm  P: ${$("e_p").value.trim()} ms  PR: ${$("e_pr").value.trim()} ms  QRS: ${$("e_qrs").value.trim()} ms  QTm: ${$("e_qtm").value.trim()} ms  QTc: ${$("e_qtc").value.trim()} ms (${$("e_qtc_method")?.textContent||""})  Eje: ${$("e_eje").value.trim()}  Transici√≥n: ${$("e_trans").value.trim()}  Hallazgos: ${$("e_find").value.trim()}`.replace(/\s+/g," ").trim();
  }

function buildIMG(){
  const selected = imgItems;
  if(!selected.length) return "ESTUDIOS DE GABINETE: ‚Äî";

  const lines = [];
  for(const it of selected){
    const f = String(it.findings||"").trim();
    const n = String(it.name||"").trim();

    if(f){
      // Si ya viene completo (con nombre y dos puntos), lo dejamos tal cual.
      lines.push(f.replace(/\s+/g," ").trim());
      continue;
    }
    if(n){
      lines.push(`${n}: sin hallazgos relevantes. Reporte verbal.`.replace(/\s+/g," ").trim());
    }
  }

  if(!lines.length) return "ESTUDIOS DE GABINETE: ‚Äî";

  // ‚¨áÔ∏è AQU√ç est√° el cambio: t√≠tulo + salto de l√≠nea antes de la interpretaci√≥n
  return `ESTUDIOS DE GABINETE:\n${lines.join("\n")}`;
}


  function buildStaff(){
    const parts = [];
    for(let i=1;i<=2;i++){
      const pref = $(`ads${i}_pref`).value;
      const name = $(`ads${i}_name`).value.trim();
      if(name) parts.push(`${pref} ${name} MA Urgencias`.replace(/\s+/g," ").trim());
    }
    for(let i=1;i<=4;i++){
      const pref = $(`res${i}_pref`).value;
      const name = $(`res${i}_name`).value.trim();
      if(!name) continue;
      const r = $(`res${i}_r`).value;
      const spec = $(`res${i}_spec`).value;
      const other = $(`res${i}_other`).value.trim();
      const s = (spec==="other") ? (other || "OTRO") : spec;
      parts.push(`${pref} ${name} R${r}${s}`.replace(/\s+/g," ").trim());
    }
    const mip = $("mip_name").value.trim();
    if(mip) parts.push(`MIP ${mip}`.replace(/\s+/g," ").trim());
    return parts.join(" // ");
  }

  function buildAll(){
    const date = $("n_date").value.trim() || "(insertar fecha)";
    const chunks = [];

    chunks.push(`NOTA DE EVOLUCI√ìN URGENCIAS\n${date}\n${fmtSV()}\n\n${buildCoreNarrative()}`);

    const req = buildReqText();
    if(req) chunks.push(req);

    const extra = $("n_extra").value.trim();
    if(extra) chunks.push(extra);

    // Estudios ANTES de comunicaci√≥n
    if($("incl_gas").checked){
      const g = buildGas();
      if(!g.endsWith("‚Äî")) chunks.push(g);
    }
    if($("incl_ecg").checked){
      const e = buildECG();
      if(!e.endsWith("‚Äî")) chunks.push(e);
    }
    if($("incl_img").checked){
      const i = buildIMG();
      if(!i.endsWith("‚Äî")) chunks.push(i);
    }

    const comm = buildComm();
if(comm) chunks.push(comm);

if($("opt_follow")?.checked){
  const doc = $("follow_doc")?.value?.trim() || "Dr. ___";
  chunks.push(`Paciente con evoluci√≥n cl√≠nica estable posterior a manejo instaurado. Se entrega receta m√©dica. Se explican signos de alarma y se indica acudir a atenci√≥n m√©dica en caso necesario. Se proporciona contacto del ${doc} para seguimiento ambulatorio.`);
}

chunks.push(dispoText());

    chunks.push(buildStaff() || "**INSERTAR NOMBRE DE M√âDICOS**");

    return chunks.join("\n\n").replace(/\n{3,}/g,"\n\n").trim();
  }

  function renderAll(){
    updateQTcAuto();
    updateAnionGap();
    renderGasEducation();
    $("allText").textContent = buildAll();
  }

  function setToday(){
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = String(d.getFullYear()).slice(-2);
    $("n_date").value = `${dd}.${mm}.${yy}`;
  }

  function coreNormal(){
    setToday();
    $("n_service").value = "Urgencias";
    $("n_sex").value = "m";

    $("sv_ta").value = "120/80";
    $("sv_fc").value = "80";
    $("sv_fr").value = "18";
    $("sv_temp").value = "36.7";
    $("sv_spo2").value = "96";

    $("opt_ef").checked = true;
    $("opt_iv").checked = true;
    $("opt_med").checked = true;

    $("iv_sol").value = "+";
    $("iv_rate").value = "+";

    $("med_name").value = "+";
    $("med_for").value = "+";

    $("opt_labs").checked = true;
    $("opt_imgreq").checked = true;
    $("req_labs").value = "BH, QS, EGO";
    $("req_img").value = "Radiograf√≠a de t√≥rax";

    $("opt_comm").checked = true;
    $("doc_name").value = "Dr. ****";
    $("doc_role").value = "(M√©dico ***)";
    $("doc_decision").value = "+";

    $("dispo").value = "egreso";
    $("dispo_custom").value = "";
    $("n_extra").value = "";
  }

  function coreClear(){
    ["n_service","sv_ta","sv_fc","sv_fr","sv_temp","sv_spo2","iv_sol","iv_rate","med_name","med_for","req_labs","req_img","doc_name","doc_role","doc_decision","dispo_custom","n_extra"].forEach(id=>$(id).value="");
    $("n_sex").value="m";
    $("opt_ef").checked=true;
    $("opt_iv").checked=true;
    $("opt_med").checked=true;
    $("opt_labs").checked=true;
    $("opt_imgreq").checked=true;
    $("opt_comm").checked=true;
    $("dispo").value="egreso";
    setToday();
  }

  function gasNormal(){ ["g_ph","g_pco2","g_po2","g_hb","g_so2","g_ag","g_eb","g_hco3","g_k","g_na","g_ca","g_cl","g_glu","g_lac","g_p50","g_find"].forEach(id=>$(id).value=""); $("incl_gas").checked=false; }
  function gasClear(){ gasNormal(); }

  function ecgNormal(){
    $("e_ritmo").value="sinusal";
    $("e_fc").value="80";
    ["e_p","e_pr","e_qrs","e_qtm","e_qtc","e_trans"].forEach(id=>$(id).value="");
    $("e_eje").value="normal";
    $("e_find").value="sin alteraciones agudas";
    $("incl_ecg").checked=false;
  }
  function ecgClear(){ ["e_ritmo","e_fc","e_p","e_pr","e_qrs","e_qtm","e_qtc","e_eje","e_trans","e_find"].forEach(id=>$(id).value=""); $("incl_ecg").checked=false; }

  
  function imgNormal(){ clearImgItems(); $("incl_img").checked=false; }
  function imgClear(){ imgNormal(); }

  function staffNormal(){
    $("ads1_pref").value="Dr.";
    $("ads2_pref").value="Dra.";
    ["ads1_name","ads2_name","mip_name","res1_name","res2_name","res3_name","res4_name","res1_other","res2_other","res3_other","res4_other"].forEach(id=>$(id).value="");
    ["res1_pref","res2_pref","res3_pref","res4_pref"].forEach(id=>$(id).value="Dra.");
    ["res1_r","res2_r","res3_r","res4_r"].forEach(id=>$(id).value="1");
    ["res1_spec","res2_spec","res3_spec","res4_spec"].forEach(id=>$(id).value="MI");
  }
  function staffClear(){ staffNormal(); }

  document.addEventListener("input", ()=>renderAll());

  // Delegaci√≥n de eventos: gabinete din√°mico
  document.addEventListener("change", (e)=>{
    const study = e.target.closest("[data-img-study]");
    if(study){
      const id = study.getAttribute("data-img-study");
      const it = imgItems.find(x=>x.id===id);
      if(it){
        it.studyKey = study.value;
        // Si el estudio es manual, forzamos modo Manual
        if(it.studyKey==="manual"){
          it.mode = "Manual";
          if(!it.name) it.name = "";
        }else{
          it.name = it.studyKey;
          if(it.mode!=="Manual"){
            it.mode = "Plantilla";
            it.findings = IMG_TEMPLATES[it.studyKey] || it.findings || "";
          }
        }
        renderImgList();
        renderAll();
      }
      return;
    }

    const mode = e.target.closest("[data-img-mode]");
    if(mode){
      const id = mode.getAttribute("data-img-mode");
      const it = imgItems.find(x=>x.id===id);
      if(it){
        it.mode = mode.value;
        // Si cambia a Plantilla y no es manual, rellenar con plantilla
        if(it.mode==="Plantilla" && it.studyKey!=="manual"){
          it.findings = IMG_TEMPLATES[it.studyKey] || it.findings || "";
        }
        renderImgList();
        renderAll();
      }
      return;
    }
  });

  document.addEventListener("input", (e)=>{
    const name = e.target.closest("[data-img-name]");
    if(name){
      const id = name.getAttribute("data-img-name");
      const it = imgItems.find(x=>x.id===id);
      if(it){ it.name = name.value; renderAll(); }
      return;
    }
    const find = e.target.closest("[data-img-find]");
    if(find){
      const id = find.getAttribute("data-img-find");
      const it = imgItems.find(x=>x.id===id);
      if(it){ it.findings = find.value; renderAll(); }
      return;
    }
  });

  document.addEventListener("click", (e)=>{
    const del = e.target.closest("[data-img-del]");
    if(del){
      const id = del.getAttribute("data-img-del");
      imgItems = imgItems.filter(x=>x.id!==id);
      renderImgList();
      renderAll();
    }
  });

document.addEventListener("change", ()=>renderAll());

  document.addEventListener("click", async (e)=>{
    const btn = e.target.closest("[data-copy]");
    if(!btn) return;
    const el = $(btn.getAttribute("data-copy"));
    if(el) await copyText(el.textContent || "");
  });

  $("coreNormal").addEventListener("click", ()=>{coreNormal(); renderAll();});
  $("coreClear").addEventListener("click", ()=>{coreClear(); renderAll();});
  $("gasNormal").addEventListener("click", ()=>{gasNormal(); renderAll();});
  $("gasClear").addEventListener("click", ()=>{gasClear(); renderAll();});
  $("ecgNormal").addEventListener("click", ()=>{ecgNormal(); renderAll();});
  $("ecgClear").addEventListener("click", ()=>{ecgClear(); renderAll();});
  $("imgAdd").addEventListener("click", ()=>{ addImgItem(); renderAll(); });
  $("imgClear").addEventListener("click", ()=>{ imgClear(); renderAll(); });
  $("staffNormal").addEventListener("click", ()=>{staffNormal(); renderAll();});
  $("staffClear").addEventListener("click", ()=>{staffClear(); renderAll();});

  $("btnAllNormal").addEventListener("click", ()=>{
    coreNormal(); gasNormal(); ecgNormal(); imgClear(); staffNormal(); renderImgList();
    renderAll(); toast("Todo normal ‚úÖ");
  });
  $("btnAllClear").addEventListener("click", ()=>{
    coreClear(); gasClear(); ecgClear(); imgClear(); staffClear();
    $("incl_gas").checked=false; $("incl_ecg").checked=false; $("incl_img").checked=false;
    renderAll(); toast("Limpio üßπ");
  });

  // Init after DOM ready
  window.addEventListener("DOMContentLoaded", ()=>{
    coreNormal(); gasNormal(); ecgNormal(); imgClear(); staffNormal(); renderImgList();
    renderAll();
  });
</script>
</body>
</html>
